<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mood Tracker - Auth</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-900 min-h-screen flex items-center justify-center px-4">
    <div
      class="bg-gray-800 text-white rounded-3xl shadow-lg p-8 w-full max-w-md"
    >
      <!-- Login Form -->
      <div id="loginForm">
        <h2 class="text-3xl font-bold mb-6 text-center">Mood Tracker</h2>

        <!-- Alert -->
        <div id="alertMessage" class="hidden mb-4 p-4 rounded-lg text-sm"></div>

        <form id="loginFormElement" class="space-y-4">
          <div>
            <label class="block mb-1 font-medium">Email</label>
            <input
              id="loginEmail"
              type="email"
              placeholder="you@example.com"
              class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label class="block mb-1 font-medium">Password</label>
            <div class="relative">
              <input
                id="loginPassword"
                type="password"
                class="w-full p-3 pr-10 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
              <button
                type="button"
                id="toggleLoginPassword"
                class="absolute right-3 top-3 text-gray-400 hover:text-white"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>

          <button
            id="loginBtn"
            type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 transition text-white font-semibold py-2 rounded-md flex items-center justify-center"
          >
            <div id="loginSpinner" class="hidden animate-spin mr-2">‚è≥</div>
            <span id="loginBtnText">Sign In</span>
          </button>
        </form>

        <p class="text-sm text-gray-400 mt-6 text-center">
          Don't have an account?
          <button id="showSignup" class="text-blue-400 hover:underline ml-1">
            Sign up
          </button>
        </p>
      </div>

      <!-- Signup Form -->
      <div id="signupForm" class="hidden">
        <h2 class="text-3xl font-bold mb-6 text-center">Create Account</h2>

        <!-- Alert -->
        <div
          id="signupAlertMessage"
          class="hidden mb-4 p-4 rounded-lg text-sm"
        ></div>

        <form id="signupFormElement" class="space-y-4">
          <div>
            <label class="block mb-1 font-medium">Name</label>
            <input
              id="signupName"
              type="text"
              placeholder="Your name"
              class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label class="block mb-1 font-medium">Email</label>
            <input
              id="signupEmail"
              type="email"
              placeholder="you@example.com"
              class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label class="block mb-1 font-medium">Password</label>
            <div class="relative">
              <input
                id="signupPassword"
                type="password"
                placeholder="At least 6 characters"
                class="w-full p-3 pr-10 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
              <button
                type="button"
                id="toggleSignupPassword"
                class="absolute right-3 top-3 text-gray-400 hover:text-white"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>

          <button
            id="signupBtn"
            type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 transition text-white font-semibold py-2 rounded-md flex items-center justify-center"
          >
            <div id="signupSpinner" class="hidden animate-spin mr-2">‚è≥</div>
            <span id="signupBtnText">Sign Up</span>
          </button>
        </form>

        <p class="text-sm text-gray-400 mt-6 text-center">
          Already have an account?
          <button id="showLogin" class="text-blue-400 hover:underline ml-1">
            Log in
          </button>
        </p>
      </div>
    </div>

    <script>
      // API Configuration
      const API_BASE_URL = "http://localhost:5000/api";

      // DOM Elements
      const loginForm = document.getElementById("loginForm");
      const signupForm = document.getElementById("signupForm");
      const showSignupBtn = document.getElementById("showSignup");
      const showLoginBtn = document.getElementById("showLogin");

      // Toggle between login and signup forms
      if (showSignupBtn && showLoginBtn) {
        showSignupBtn.addEventListener("click", () => {
          loginForm.classList.add("hidden");
          signupForm.classList.remove("hidden");
        });

        showLoginBtn.addEventListener("click", () => {
          signupForm.classList.add("hidden");
          loginForm.classList.remove("hidden");
        });
      }

      // Password toggle functionality
      const toggleLoginPassword = document.getElementById(
        "toggleLoginPassword"
      );
      const toggleSignupPassword = document.getElementById(
        "toggleSignupPassword"
      );

      if (toggleLoginPassword) {
        toggleLoginPassword.addEventListener("click", () => {
          togglePasswordVisibility("loginPassword", "toggleLoginPassword");
        });
      }

      if (toggleSignupPassword) {
        toggleSignupPassword.addEventListener("click", () => {
          togglePasswordVisibility("signupPassword", "toggleSignupPassword");
        });
      }

      function togglePasswordVisibility(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);

        if (input.type === "password") {
          input.type = "text";
          button.textContent = "üôà";
        } else {
          input.type = "password";
          button.textContent = "üëÅÔ∏è";
        }
      }

      // Utility function to show alerts
      function showAlert(elementId, message, type = "error") {
        const alertElement = document.getElementById(elementId);
        if (!alertElement) return;

        alertElement.className = `mb-4 p-4 rounded-lg ${
          type === "error"
            ? "bg-red-100 text-red-700 border border-red-300"
            : "bg-green-100 text-green-700 border border-green-300"
        }`;
        alertElement.textContent = message;
        alertElement.classList.remove("hidden");

        // Auto-hide after 5 seconds
        setTimeout(() => {
          alertElement.classList.add("hidden");
        }, 5000);
      }

      // Show/hide loading spinner
      function toggleLoading(buttonId, spinnerId, textId, isLoading) {
        const button = document.getElementById(buttonId);
        const spinner = document.getElementById(spinnerId);
        const text = document.getElementById(textId);

        if (!button || !spinner || !text) return;

        if (isLoading) {
          button.disabled = true;
          button.classList.add("opacity-75", "cursor-not-allowed");
          spinner.classList.remove("hidden");
          text.textContent = "Please wait...";
        } else {
          button.disabled = false;
          button.classList.remove("opacity-75", "cursor-not-allowed");
          spinner.classList.add("hidden");
          text.textContent = buttonId.includes("login") ? "Sign In" : "Sign Up";
        }
      }

      // Login functionality
      const loginFormElement = document.getElementById("loginFormElement");
      if (loginFormElement) {
        loginFormElement.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("loginEmail").value.trim();
          const password = document.getElementById("loginPassword").value;

          // Basic validation
          if (!email || !password) {
            showAlert("alertMessage", "Please fill in all fields");
            return;
          }

          toggleLoading("loginBtn", "loginSpinner", "loginBtnText", true);

          try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (data.success) {
              // ‚úÖ Store JWT token in localStorage
              localStorage.setItem("token", data.token);

              showAlert(
                "alertMessage",
                "Login successful! Redirecting...",
                "success"
              );

              // ‚úÖ Redirect to dashboard
              setTimeout(() => {
                window.location.href = "dashboard.html";
              }, 1000);
            } else {
              showAlert("alertMessage", data.message || "Login failed");
            }
          } catch (error) {
            console.error("Login error:", error);
            showAlert(
              "alertMessage",
              "Network error. Please check if the server is running."
            );
          } finally {
            toggleLoading("loginBtn", "loginSpinner", "loginBtnText", false);
          }
        });
      }

      // Signup functionality
      const signupFormElement = document.getElementById("signupFormElement");
      if (signupFormElement) {
        signupFormElement.addEventListener("submit", async (e) => {
          e.preventDefault();

          const name = document.getElementById("signupName").value.trim();
          const email = document.getElementById("signupEmail").value.trim();
          const password = document.getElementById("signupPassword").value;

          // Basic validation
          if (!name || !email || !password) {
            showAlert("signupAlertMessage", "Please fill in all fields");
            return;
          }

          if (password.length < 6) {
            showAlert(
              "signupAlertMessage",
              "Password must be at least 6 characters long"
            );
            return;
          }

          // Password strength validation
          const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/;
          if (!passwordRegex.test(password)) {
            showAlert(
              "signupAlertMessage",
              "Password must contain at least one uppercase letter, lowercase letter, and number"
            );
            return;
          }

          toggleLoading("signupBtn", "signupSpinner", "signupBtnText", true);

          try {
            const response = await fetch(`${API_BASE_URL}/auth/signup`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name, email, password }),
            });

            const data = await response.json();

            if (data.success) {
              showAlert(
                "signupAlertMessage",
                "Account created successfully! Redirecting...",
                "success"
              );

              // Simulate redirect after 1 second
              setTimeout(() => {
                alert(
                  "Account created! You would be redirected to dashboard.html"
                );
                window.location.href = "dashboard.html";
              }, 1000);
            } else {
              let errorMessage = data.message || "Registration failed";

              // Handle validation errors
              if (data.errors && data.errors.length > 0) {
                errorMessage = data.errors.map((err) => err.msg).join(", ");
              }

              showAlert("signupAlertMessage", errorMessage);
            }
          } catch (error) {
            console.error("Signup error:", error);
            showAlert(
              "signupAlertMessage",
              "Network error. Please check if the server is running."
            );
          } finally {
            toggleLoading("signupBtn", "signupSpinner", "signupBtnText", false);
          }
        });
      }

      // Check if user is already logged in (simulated)
      function checkAuthStatus() {
        // In a real app, you'd check localStorage or sessionStorage here
        console.log("Checking auth status...");
      }

      // Check auth status on page load
      document.addEventListener("DOMContentLoaded", checkAuthStatus);
    </script>
  </body>
</html>
